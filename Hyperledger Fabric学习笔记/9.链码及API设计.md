# 结构体设计

## 苹果树 ProdOri

| 字段名称   | 别名                       | 数据类型 |
| ---------- | -------------------------- | -------- |
| OriId      | 苹果树编号                 | string   |
| OriName    | 苹果树名称                 | string   |
| OriOwner   | 当前的拥有者               | string   |
| CreateTime | 生成日期                   | string   |
| PkgIds     | 所有苹果被包装成包裹的编号 | string   |
| MaxPkgNo   | 包裹数量（用于给包裹命名） | unit     |

> 字段`OriName  苹果树名称  string`先舍弃

`ProdOri{OriId: "a003", OriName: "苹果树C", OriOwner: "农场主A", CreateTime: "2006-01-04 15:04:05", PkgIds: []string{}`

## 运输苹果的包裹 ProdPkg

| 字段名称 | 别名                   | 数据类型 | 备注                 |
| -------- | ---------------------- | -------- | -------------------- |
| PkgId    | 包裹编号               | string   |                      |
| PkgOriId | 包裹产品来源Id(苹果树) | string   |                      |
| OpTime   | 操作日期               | string   |                      |
| OpType   | 操作类型               | string   | create, send, arrive |
| OpDesc   | 操作说明               | string   | 默认为空             |
| Opr      | 操作者                 | string   |                      |
| OpLoc    | 操作地理位置           | string   |                      |

`ProdId: "p001", PkgOriId: "a001", OpTime: time.Now().Format(dateFormat), OpType: "create", OpDesc: "无", Opr: "操作员A", OpLoc: "南京"`

# Api

## AppleOrchard 苹果园

### 添加苹果树 addProdOri()

方法描述：添加苹果树数据

| 参数       | 类型   | 含义       |
| ---------- | ------ | ---------- |
| oriId      | string | 苹果树编号 |
| oriOwner   | string | 拥有者     |
| createTime | string | 创建时间   |

```BASH
# 案例
peer chaincode invoke -n mycc -c '{"Args": ["addProdOri", "a004", "农场主F", "2009-03-14 02:50:59"]}' -C myc
# 返回值
Chaincode invoke successful. result: status:200
# 失败案例（重新创建相同id的苹果树）
peer chaincode invoke -n mycc -c '{"Args": ["addProdOri", "a004", "农场主F", "2009-03-14 02:50:59"]}' -C myc
Error: endorsement failure during invoke. response: status:500 message:"This product package already exists: \350\213\271\346\236\234\346\240\221a004" 

```



### 添加包裹 addPkg()

> PkgId为自动生成，`pkgOriId + prodOri.MaxPkgNo(当前pkg数量))`
>
> OpType为`create`
>
> OpDesc默认为`空`

方法描述：添加包裹，包裹Id会根据产品来源和数量自动生成。

| 参数     | 类型   | 含义                   |
| -------- | ------ | ---------------------- |
| pkgOriId | string | 包裹产品来源Id(苹果树) |
| OpTime   | string | 操作日期               |
| Opr      | string | 操作者                 |
| OpLoc    | string | 操作地理位置           |

```BASH
# 案例
peer chaincode invoke -n mycc -c '{"Args": ["addPkg", "a004", "2019-03-14 02:50:59", "操作员G", "扬州"]}' -C myc
# 返回值
Chaincode invoke successful. result: status:200
# 失败案例
peer chaincode invoke -n mycc -c '{"Args": ["addPkg", "a005", "2019-03-14 02:50:59", "操作员G", "扬州"]}' -C myc
Error: endorsement failure during invoke. response: status:500 message:"The product origin does not exist: a005" 

```





### 发送包裹 sendPkg()

OpType：`send`

| 参数   | 类型   | 含义         |
| ------ | ------ | ------------ |
| PkgId  | string | 包裹编号     |
| OpTime | string | 操作日期     |
| Opr    | string | 操作者       |
| OpLoc  | string | 操作地理位置 |
| OpDesc | string | 描述         |

```BASH
# 案例
peer chaincode invoke -n mycc -c '{"Args":["sendPkg", "a001000001", "2019-05-14 02:50:59", "运输员A", "扬州", "描述：从南京到扬州"]}' -C myc
# 返回值
Chaincode invoke successful. result: status:200
# 失败案例（发送一个不存在的包裹，无法找到 所以报错）
peer chaincode invoke -n mycc -c '{"Args":["sendPkg", "a001000006", "2019-05-14 02:50:59", "运输员A", "扬州", "描述：从南京到扬州"]}' -C myc
Error: endorsement failure during invoke. response: status:500 message:"JSON deserialization for product package failed: unexpected end of JSON input" 
```



### 获取苹果树信息 getOriById()

方法描述：获取指定产品源头（如苹果树）的全部信息（苹果树编号、苹果树名称、当前的拥有者、生成日期、所有苹果被包装成包裹的编号、所采摘组装成包裹的数量）

| 参数  | 类型   | 含义     |
| ----- | ------ | -------- |
| oriId | string | 包裹编号 |

```BASH
# 案例
peer chaincode invoke -n mycc -c '{"Args": ["getOriById", "a004"]}' -C myc
# 返回值
Chaincode invoke successful. result: status:200 payload:"{\"oriId\":\"a004\",\"oriName\":\"\350\213\271\346\236\234\346\240\221a004\",\"oriOwner\":\"\345\206\234\345\234\272\344\270\273F\",\"createTime\":\"2009-03-14 02:50:59\",\"pkgIds\":[],\"MaxPkgNo\":0}"
# 失败案例
peer chaincode invoke -n mycc -c '{"Args": ["getOriById", "a005"]}' -C myc
Error: endorsement failure during invoke. response: status:500 message:"{\"Error\": \"Product origin does not exist: a005\" }"
```





### 获取包裹当前信息 getPkgLastRec()

方法描述：获取指定包裹的所有信息（包裹编号、包裹产品来源、操作日期、操作类型、操作说明、操作者、操作地理位置）

| 参数  | 类型   | 含义     |
| ----- | ------ | -------- |
| pkgId | string | 包裹编号 |

```BASH
# 举例
peer chaincode invoke -n mycc -c '{"Args":["getPkgLastRec", "a001000001"]}' -C myc
# 返回值：
Chaincode invoke successful. result: status:200 payload:"{\"pkgId\":\"a001000001\",\"pkgOriId\":\"a001\",\"opTime\":\"2021-03-14 13:18:52\",\"opType\":\"create\",\"opDesc\":\"\346\227\240\",\"opr\":\"\346\223\215\344\275\234\345\221\230A\",\"opLoc\":\"\345\215\227\344\272\254\"}"

# 失败案例
peer chaincode invoke -n mycc -c '{"Args":["getPkgLastRec", "a001000001"]}' -C myc
Error: endorsement failure during invoke. response: status:500 message:"{\"Error\": \"Product package does not exist: a003000001\" }"
```



### 查询包裹的历史记录 getPkgHist

方法描述：获取指定包裹的历史记录

| 参数  | 类型   | 含义     |
| ----- | ------ | -------- |
| pkgId | string | 包裹编号 |

```BASH
# 举例
peer chaincode invoke -n mycc -c '{"Args":["getPkgHist", "a001000001"]}' -C myc

# 返回值（保存会序列化为bytes），下方为转换为JSON后的值
Chaincode invoke successful. result: status:200 payload:"[{\"TxId\":\"14760272df7acb9d7e75186dc228baaba86bd958ea71edf16a2c3a92d983eef1\", \"Value\":{\"pkgId\":\"a001000001\",\"pkgOriId\":\"a001\",\"opTime\":\"2021-03-14 14:05:19\",\"opType\":\"create\",\"opDesc\":\"\346\227\240\",\"opr\":\"\346\223\215\344\275\234\345\221\230A\",\"opLoc\":\"\345\215\227\344\272\254\"}, \"Timestamp\":\"2021-03-14 14:05:19.210965074 +0000 UTC\", \"IsDelete\":\"false\"},{\"TxId\":\"e79cf71a4aeba3d5ac86f8bb37701dd171bf838e41078c2b35be615e43ffd1e2\", \"Value\":{\"pkgId\":\"a001000001\",\"pkgOriId\":\"a001\",\"opTime\":\"2019-05-14 02:50:59\",\"opType\":\"send\",\"opDesc\":\"\346\217\217\350\277\260\357\274\232\344\273\216\345\215\227\344\272\254\345\210\260\346\211\254\345\267\236\",\"opr\":\"\350\277\220\350\276\223\345\221\230A\",\"opLoc\":\"\346\211\254\345\267\236\"}, \"Timestamp\":\"2021-03-14 14:06:47.544430344 +0000 UTC\", \"IsDelete\":\"false\"}]"
## 转换后
[{"TxId":"14760272df7acb9d7e75186dc228baaba86bd958ea71edf16a2c3a92d983eef1", "Value":{"pkgId":"a001000001","pkgOriId":"a001","opTime":"2021-03-14 14:05:19","opType":"create","opDesc":"无","opr":"操作员A","opLoc":"南京"}, "Timestamp":"2021-03-14 14:05:19.210965074 +0000 UTC", "IsDelete":"false"},{"TxId":"e79cf71a4aeba3d5ac86f8bb37701dd171bf838e41078c2b35be615e43ffd1e2", "Value":{"pkgId":"a001000001","pkgOriId":"a001","opTime":"2019-05-14 02:50:59","opType":"send","opDesc":"描述：从南京到扬州","opr":"运输员A","opLoc":"扬州"}, "Timestamp":"2021-03-14 14:06:47.544430344 +0000 UTC", "IsDelete":"false"}]

# 失败案例（如包裹id不存在）
peer chaincode invoke -n mycc -c '{"Args":["getPkgHist", "a001000005"]}' -C myc
Error: endorsement failure during invoke. response: status:500 message:"Query operation failed. Package a001000005 does not exist" 
```

