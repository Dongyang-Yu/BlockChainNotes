# 两个概念

* 虚拟机virtual machine

  * 用于搭建虚拟开发环境
  * 和容器区分开来

* Vagrant

  * vagrant是一个工具，用于创建和部署虚拟化开发环境的命令行工具。

    拿VirtualBox举例，VirtualBox会开放一个创建虚拟机的接口，Vagrant会利用这个接口创建虚拟机，并且通过Vagrant来管理，配置和自动安装虚拟机。




# Fabric[环境搭建](https://blog.csdn.net/weixin_44732379/article/details/108631041?utm_medium=distribute.pc_relevant.none-task-blog-baidujs_title-6&spm=1001.2101.3001.4242)

## 安装前说明

Centos7 64位Linux操作系统。
需要安装3个基本环境Docker、Docker-Compose、Go语言环境安装，之后下载Fabric源码，最后测试网络
检查服务器内核版本，cmd：`uname -r`，要在3以上

## Go语言安装

**配置环境变量**

在`/etc/profile`文件末尾添加环境变量

```bash
// 创建go工作目录
mkdir /opt/gopath
vi /etc/profile               //在文件末尾添加
export GOPATH=/usr/local/go   //笔者将go安装在/usr/local/go路径下
export PATH=$GOPATH/bin:$PATH
```

接着运行命令使其生效

```bash
source /etc/profile
```

> 官方文档提供的链接需要翻墙才能安装，故不考虑

## Fabric安装

> 注意：fabric源码需放在go路径下，因为Fabric代码由Go语言（全称Golang）构建

1. 创建目录并进入

```bash
mkdir -p $GOPATH/src/github.com/hyperledger
cd $GOPATH/src/github.com/hyperledger
```

2. 下载源码

```BASH
git clone https://github.com/hyperledger/fabric.git
```

3. 查看并切换分支，笔者选择的是**v1.4.0**版本

```bash
cd ./fabric
git branch -a
git checkout release-1.4
```



# 安装Fabric-sample示例

进入`fabric/scripts`目录可以看到一个`bootstrap.sh`脚本

> **注意**：需要赋予bootstrap.sh可执行权限！否则会失败，一个晚上耗费在这！
>
> <u>编写完了一个.sh，没有可执行权限x肯定是无法运行的</u>
>
> ```bash
> chmod +x bootstrap.sh
> ```

赋予可执行权限后，运行脚本。

> **注意**：需要指定版本号，不指定版本号默认下载最新版，分别是Fabric、Fabric-ca 和第三方 Docker 镜像的版本号
>
> ```bash
> ./bootstrap.sh <fabric_version> <fabric-ca_version> <thirdparty_version>
> ```

```BASH
./bootstrap.sh 1.4.0 1.4.0 0.4.15
```

查看该脚本，主要做了以下几件事：

* 从 github.com 克隆 hyperledger/fabric-samples 仓库
* 使用 checkout 签出对应指定的版本标签（如fabric）；

* 将二进制文件(bin)和配置文件(config)安装到 fabric-samples 存储库的根目录中；
* 下载指定版本的 Hyperledger Fabric Docker 镜像文件，将下载的 Docker 镜像文件标记为 “lastest"。

安装完成后，出现一系列docker镜像，或者使用命令`docker images`查看， 如下图所示：

![image-20210114210322447](%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.assets/image-20210114210322447.png)

# 测试网络

相比较1.1版本，e2e案例被移除，所以测试网络使用**fabric-samples** 中的 **first-network**

```BASH
cd ./fabric-samples/first-network/
```

> 注意：此时如果直接启动网络会报错
>
> `./byfn.sh up`
>
> ![image-20210114211238409](%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.assets/image-20210114211238409.png)

因为需要首先**生成密码**，所以首先关闭该旧网络

```BASH
./byfn.sh down
./byfn.sh generate
./byfn.sh up #重新启动即可
```

细节如下：

```bash
root@localhost first-network ((detached from v1.4.0)) # ./byfn.sh -m generate
Generating certs and genesis block for channel 'mychannel' with CLI timeout of '10' seconds and CLI delay o            f '3' seconds
Continue? [Y/n] y
proceeding ...
/usr/local/go/src/github.com/hyperledger/fabric/scripts/fabric-samples/bin/cryptogen

##########################################################
##### Generate certificates using cryptogen tool #########
##########################################################
+ cryptogen generate --config=./crypto-config.yaml
org1.example.com
org2.example.com
+ res=0
+ set +x

/usr/local/go/src/github.com/hyperledger/fabric/scripts/fabric-samples/bin/configtxgen
##########################################################
#########  Generating Orderer Genesis block ##############
##########################################################
CONSENSUS_TYPE=solo
+ '[' solo == solo ']'
+ configtxgen -profile TwoOrgsOrdererGenesis -channelID byfn-sys-channel -outputBlock ./channel-artifacts/g            enesis.block
2021-01-14 08:06:06.773 EST [common.tools.configtxgen] main -> INFO 001 Loading configuration
2021-01-14 08:06:06.802 EST [common.tools.configtxgen.localconfig] completeInitialization -> INFO 002 order            er type: solo
2021-01-14 08:06:06.803 EST [common.tools.configtxgen.localconfig] Load -> INFO 003 Loaded configuration: /            usr/local/go/src/github.com/hyperledger/fabric/scripts/fabric-samples/first-network/configtx.yaml
2021-01-14 08:06:06.829 EST [common.tools.configtxgen.localconfig] completeInitialization -> INFO 004 order            er type: solo
2021-01-14 08:06:06.829 EST [common.tools.configtxgen.localconfig] LoadTopLevel -> INFO 005 Loaded configur            ation: /usr/local/go/src/github.com/hyperledger/fabric/scripts/fabric-samples/first-network/configtx.yaml
2021-01-14 08:06:06.831 EST [common.tools.configtxgen] doOutputBlock -> INFO 006 Generating genesis block
2021-01-14 08:06:06.831 EST [common.tools.configtxgen] doOutputBlock -> INFO 007 Writing genesis block
+ res=0
+ set +x

#################################################################
### Generating channel configuration transaction 'channel.tx' ###
#################################################################
+ configtxgen -profile TwoOrgsChannel -outputCreateChannelTx ./channel-artifacts/channel.tx -channelID mych            annel
2021-01-14 08:06:06.861 EST [common.tools.configtxgen] main -> INFO 001 Loading configuration
2021-01-14 08:06:06.888 EST [common.tools.configtxgen.localconfig] Load -> INFO 002 Loaded configuration: /            usr/local/go/src/github.com/hyperledger/fabric/scripts/fabric-samples/first-network/configtx.yaml
2021-01-14 08:06:06.914 EST [common.tools.configtxgen.localconfig] completeInitialization -> INFO 003 order            er type: solo
2021-01-14 08:06:06.914 EST [common.tools.configtxgen.localconfig] LoadTopLevel -> INFO 004 Loaded configur            ation: /usr/local/go/src/github.com/hyperledger/fabric/scripts/fabric-samples/first-network/configtx.yaml
2021-01-14 08:06:06.914 EST [common.tools.configtxgen] doOutputChannelCreateTx -> INFO 005 Generating new c            hannel configtx
2021-01-14 08:06:06.916 EST [common.tools.configtxgen] doOutputChannelCreateTx -> INFO 006 Writing new chan            nel tx
+ res=0
+ set +x

#################################################################
#######    Generating anchor peer update for Org1MSP   ##########
#################################################################
+ configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/Org1MSPanchors.tx -chann            elID mychannel -asOrg Org1MSP
2021-01-14 08:06:06.945 EST [common.tools.configtxgen] main -> INFO 001 Loading configuration
2021-01-14 08:06:06.972 EST [common.tools.configtxgen.localconfig] Load -> INFO 002 Loaded configuration: /            usr/local/go/src/github.com/hyperledger/fabric/scripts/fabric-samples/first-network/configtx.yaml
2021-01-14 08:06:06.998 EST [common.tools.configtxgen.localconfig] completeInitialization -> INFO 003 order            er type: solo
2021-01-14 08:06:06.998 EST [common.tools.configtxgen.localconfig] LoadTopLevel -> INFO 004 Loaded configur            ation: /usr/local/go/src/github.com/hyperledger/fabric/scripts/fabric-samples/first-network/configtx.yaml
2021-01-14 08:06:06.998 EST [common.tools.configtxgen] doOutputAnchorPeersUpdate -> INFO 005 Generating anc            hor peer update
2021-01-14 08:06:06.998 EST [common.tools.configtxgen] doOutputAnchorPeersUpdate -> INFO 006 Writing anchor             peer update
+ res=0
+ set +x

#################################################################
#######    Generating anchor peer update for Org2MSP   ##########
#################################################################
+ configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/Org2MSPanchors.tx -chann            elID mychannel -asOrg Org2MSP
2021-01-14 08:06:07.028 EST [common.tools.configtxgen] main -> INFO 001 Loading configuration
2021-01-14 08:06:07.054 EST [common.tools.configtxgen.localconfig] Load -> INFO 002 Loaded configuration: /            usr/local/go/src/github.com/hyperledger/fabric/scripts/fabric-samples/first-network/configtx.yaml
2021-01-14 08:06:07.081 EST [common.tools.configtxgen.localconfig] completeInitialization -> INFO 003 order            er type: solo
2021-01-14 08:06:07.081 EST [common.tools.configtxgen.localconfig] LoadTopLevel -> INFO 004 Loaded configur            ation: /usr/local/go/src/github.com/hyperledger/fabric/scripts/fabric-samples/first-network/configtx.yaml
2021-01-14 08:06:07.081 EST [common.tools.configtxgen] doOutputAnchorPeersUpdate -> INFO 005 Generating anc            hor peer update
2021-01-14 08:06:07.081 EST [common.tools.configtxgen] doOutputAnchorPeersUpdate -> INFO 006 Writing anchor             peer update
+ res=0
+ set +x

root@localhost first-network ((detached from v1.4.0)) # ./byfn.sh up
Starting for channel 'mychannel' with CLI timeout of '10' seconds and CLI delay of '3' seconds
Continue? [Y/n] y
proceeding ...
LOCAL_VERSION=1.4.0
DOCKER_IMAGE_VERSION=1.4.0
Creating network "net_byfn" with the default driver
Creating volume "net_orderer.example.com" with default driver
Creating volume "net_peer0.org1.example.com" with default driver
Creating volume "net_peer1.org1.example.com" with default driver
Creating volume "net_peer0.org2.example.com" with default driver
Creating volume "net_peer1.org2.example.com" with default driver
Creating peer0.org2.example.com ... done
Creating peer1.org2.example.com ... done
Creating peer0.org1.example.com ... done
Creating peer1.org1.example.com ... done
Creating orderer.example.com    ... done
Creating cli                    ... done

 ____    _____      _      ____    _____
/ ___|  |_   _|    / \    |  _ \  |_   _|
\___ \    | |     / _ \   | |_) |   | |
 ___) |   | |    / ___ \  |  _ <    | |
|____/    |_|   /_/   \_\ |_| \_\   |_|

Build your first network (BYFN) end-to-end test

Channel name : mychannel
Creating channel...
+ peer channel create -o orderer.example.com:7050 -c mychannel -f ./channel-artifacts/channel.tx --tls true             --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/ordere            rs/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem
+ res=0
+ set +x
2021-01-14 13:06:23.317 UTC [channelCmd] InitCmdFactory -> INFO 001 Endorser and orderer connections initia            lized
2021-01-14 13:06:23.477 UTC [cli.common] readBlock -> INFO 002 Received block: 0
===================== Channel 'mychannel' created =====================

Having all peers join the channel...
+ peer channel join -b mychannel.block
+ res=0
+ set +x
2021-01-14 13:06:23.554 UTC [channelCmd] InitCmdFactory -> INFO 001 Endorser and orderer connections initia            lized
2021-01-14 13:06:24.091 UTC [channelCmd] executeJoin -> INFO 002 Successfully submitted proposal to join ch            annel
===================== peer0.org1 joined channel 'mychannel' =====================

+ peer channel join -b mychannel.block
+ res=0
+ set +x
2021-01-14 13:06:27.185 UTC [channelCmd] InitCmdFactory -> INFO 001 Endorser and orderer connections initia            lized
2021-01-14 13:06:27.634 UTC [channelCmd] executeJoin -> INFO 002 Successfully submitted proposal to join ch            annel
===================== peer1.org1 joined channel 'mychannel' =====================

+ peer channel join -b mychannel.block
+ res=0
+ set +x
2021-01-14 13:06:30.719 UTC [channelCmd] InitCmdFactory -> INFO 001 Endorser and orderer connections initia            lized
2021-01-14 13:06:31.164 UTC [channelCmd] executeJoin -> INFO 002 Successfully submitted proposal to join ch            annel
===================== peer0.org2 joined channel 'mychannel' =====================

+ peer channel join -b mychannel.block
+ res=0
+ set +x
2021-01-14 13:06:34.248 UTC [channelCmd] InitCmdFactory -> INFO 001 Endorser and orderer connections initia            lized
2021-01-14 13:06:34.641 UTC [channelCmd] executeJoin -> INFO 002 Successfully submitted proposal to join ch            annel
===================== peer1.org2 joined channel 'mychannel' =====================

Updating anchor peers for org1...
+ peer channel update -o orderer.example.com:7050 -c mychannel -f ./channel-artifacts/Org1MSPanchors.tx --t            ls true --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com            /orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem
+ res=0
+ set +x
2021-01-14 13:06:37.722 UTC [channelCmd] InitCmdFactory -> INFO 001 Endorser and orderer connections initia            lized
2021-01-14 13:06:37.735 UTC [channelCmd] update -> INFO 002 Successfully submitted channel update
===================== Anchor peers updated for org 'Org1MSP' on channel 'mychannel' =====================

Updating anchor peers for org2...
+ peer channel update -o orderer.example.com:7050 -c mychannel -f ./channel-artifacts/Org2MSPanchors.tx --t            ls true --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com            /orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem
+ res=0
+ set +x
2021-01-14 13:06:40.821 UTC [channelCmd] InitCmdFactory -> INFO 001 Endorser and orderer connections initia            lized
2021-01-14 13:06:40.835 UTC [channelCmd] update -> INFO 002 Successfully submitted channel update
===================== Anchor peers updated for org 'Org2MSP' on channel 'mychannel' =====================

Installing chaincode on peer0.org1...
+ peer chaincode install -n mycc -v 1.0 -l golang -p github.com/chaincode/chaincode_example02/go/
+ res=0
+ set +x
2021-01-14 13:06:43.926 UTC [chaincodeCmd] checkChaincodeCmdParams -> INFO 001 Using default escc
2021-01-14 13:06:43.926 UTC [chaincodeCmd] checkChaincodeCmdParams -> INFO 002 Using default vscc
2021-01-14 13:06:45.213 UTC [chaincodeCmd] install -> INFO 003 Installed remotely response:<status:200 payl            oad:"OK" >
===================== Chaincode is installed on peer0.org1 =====================

Install chaincode on peer0.org2...
+ peer chaincode install -n mycc -v 1.0 -l golang -p github.com/chaincode/chaincode_example02/go/
+ res=0
+ set +x
2021-01-14 13:06:45.295 UTC [chaincodeCmd] checkChaincodeCmdParams -> INFO 001 Using default escc
2021-01-14 13:06:45.296 UTC [chaincodeCmd] checkChaincodeCmdParams -> INFO 002 Using default vscc
2021-01-14 13:06:45.456 UTC [chaincodeCmd] install -> INFO 003 Installed remotely response:<status:200 payl            oad:"OK" >
===================== Chaincode is installed on peer0.org2 =====================

Instantiating chaincode on peer0.org2...
+ peer chaincode instantiate -o orderer.example.com:7050 --tls true --cafile /opt/gopath/src/github.com/hyp            erledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tl            sca.example.com-cert.pem -C mychannel -n mycc -l golang -v 1.0 -c '{"Args":["init","a","100","b","200"]}' -            P 'AND ('\''Org1MSP.peer'\'','\''Org2MSP.peer'\'')'
+ res=0
+ set +x
2021-01-14 13:06:45.520 UTC [chaincodeCmd] checkChaincodeCmdParams -> INFO 001 Using default escc
2021-01-14 13:06:45.520 UTC [chaincodeCmd] checkChaincodeCmdParams -> INFO 002 Using default vscc
===================== Chaincode is instantiated on peer0.org2 on channel 'mychannel' =====================

Querying chaincode on peer0.org1...
===================== Querying on peer0.org1 on channel 'mychannel'... =====================
Attempting to Query peer0.org1 ...3 secs
+ peer chaincode query -C mychannel -n mycc -c '{"Args":["query","a"]}'
+ res=0
+ set +x

100
===================== Query successful on peer0.org1 on channel 'mychannel' =====================
Sending invoke transaction on peer0.org1 peer0.org2...
+ peer chaincode invoke -o orderer.example.com:7050 --tls true --cafile /opt/gopath/src/github.com/hyperled            ger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.e            xample.com-cert.pem -C mychannel -n mycc --peerAddresses peer0.org1.example.com:7051 --tlsRootCertFiles /op            t/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.            example.com/tls/ca.crt --peerAddresses peer0.org2.example.com:7051 --tlsRootCertFiles /opt/gopath/src/githu            b.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca            .crt -c '{"Args":["invoke","a","b","10"]}'
+ res=0
+ set +x
2021-01-14 13:07:43.323 UTC [chaincodeCmd] chaincodeInvokeOrQuery -> INFO 001 Chaincode invoke successful.             result: status:200
===================== Invoke transaction successful on peer0.org1 peer0.org2 on channel 'mychannel' =======            ==============

Installing chaincode on peer1.org2...
+ peer chaincode install -n mycc -v 1.0 -l golang -p github.com/chaincode/chaincode_example02/go/
+ res=0
+ set +x
2021-01-14 13:07:43.387 UTC [chaincodeCmd] checkChaincodeCmdParams -> INFO 001 Using default escc
2021-01-14 13:07:43.387 UTC [chaincodeCmd] checkChaincodeCmdParams -> INFO 002 Using default vscc
2021-01-14 13:07:43.633 UTC [chaincodeCmd] install -> INFO 003 Installed remotely response:<status:200 payl            oad:"OK" >
===================== Chaincode is installed on peer1.org2 =====================

Querying chaincode on peer1.org2...
===================== Querying on peer1.org2 on channel 'mychannel'... =====================
Attempting to Query peer1.org2 ...3 secs
+ peer chaincode query -C mychannel -n mycc -c '{"Args":["query","a"]}'
+ res=0
+ set +x

90
===================== Query successful on peer1.org2 on channel 'mychannel' =====================

========= All GOOD, BYFN execution completed ===========


 _____   _   _   ____
| ____| | \ | | |  _ \
|  _|   |  \| | | | | |
| |___  | |\  | | |_| |
|_____| |_| \_| |____/

```

出现以上结果表示网络测试成功
`docker ps`命令可以查看到节点的启动情况
最后别忘了关闭网络

`./byfn.sh down`



# 启动网络失败时的解决方法

1. 清除docker容器、镜像

   ```BASH
   docker rm -f $(docker ps -aq)
   
   docker rmi -f $(docker images)
   ```

2. 关闭网络，重新启动网络

   ```BASH
   ./byfn.sh down
   
   ./byfn.sh -m generate
   
   ./byfn.sh up
   ```

3. 重新安装对应版本的二进制文件（binaries）和配置文件（config）