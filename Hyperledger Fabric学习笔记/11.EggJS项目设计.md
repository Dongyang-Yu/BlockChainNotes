# Router

> 路由设置：主路由在`app/router.js`，产品的路由单独放在`app/router/product.js`中。

参加组织的用户在主路由下，方法在`app/controller/user.js`中，名为`registerAndEnrollUser`



# 控制器

> 参考[链接](https://eggjs.org/zh-cn/basics/controller.html#%E4%BB%80%E4%B9%88%E6%98%AF-controller)，Controller主要负责解析用户的输入，处理后返回相应的结果

对于GET请求，我们采用的是`query/queries`的方式从url中获取参数。

对于POST, PUT和DELETE等请求，我们采用`body`传参，因为相比URL传参不需要显示在地址栏，所以相对更安全



## TODO: Session（根据session的用户信息获取当前登录用户的信息，录入链中）



# 服务

> Service是在复杂业务场景下用于做业务逻辑封装的一个抽象层。

当前设计了两个Service类：

* `fabric`：用于调用Fabric的链码操作，

* `product`：用于对产品进行处理的抽象逻辑，会调用`fabric`类中的方法进行更新、添加或更新数据。







# MySQL相关

> 前提概要：服务器中已安装MySQL。
>
> 使用一个 ORM 框架（Sequelize）来帮助我们管理数据层的代码

**设计和初始化我们的数据库**

```BASH
mysql -u root -e 'CREATE DATABASE IF NOT EXISTS `fabric-user-default`;'
mysql -u root -e 'CREATE DATABASE IF NOT EXISTS `fabric-user-unittest`;'
```

设计`users`表，有如下的数据结构

```mysql
CREATE TABLE `users` (
  `id` varchar(30) NOT NULL  COMMENT 'primary key and used for fabric user',
  `org` varchar(30) NOT NULL COMMENT 'the organization for the user'
  `role` varchar(10) DEFAULT 'guest' COMMENT 'the role for user',
  `name` varchar(30) DEFAULT NULL COMMENT 'user name',
  `password` varchar(30) DEFAULT NULL COMMENT 'user password',
  `created_at` datetime DEFAULT NULL COMMENT 'created time',
  `updated_at` datetime DEFAULT NULL COMMENT 'updated time',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='user';

('users', {
      id: {
        type: STRING(30),
        primaryKey: true,
        // autoIncrement: true,
        unique: true,
      },
      org: STRING(30),
      role: {
        type: STRING(10),
        default: 'guest',
      },
      name: STRING(30),
      password: STRING(30),
      created_at: DATE,
      updated_at: DATE,
    })
```

如果想通过 RESTful 的方式来定义路由， 我们提供了 `app.router.resources('routerName', 'pathMatch', controller)` 快速在一个路径上生成 CRUD 路由结构。

我们在路由中加上：

` router.resources('user', '/user', controller.user);`

> 如果我们不需要其中的某几个方法，可以不用在 `posts.js` 里面实现，这样对应 URL 路径也不会注册到 Router。

| Method | Path      | Route Name | Controller.Action            |
| ------ | --------- | ---------- | ---------------------------- |
| GET    | /user     | user       | app.controllers.user.index   |
| GET    | /user/:id | user       | app.controllers.user.show    |
| POST   | /user     | user       | app.controllers.user.create  |
| PUT    | /user/:id | user       | app.controllers.user.update  |
| DELETE | /user/:id | user       | app.controllers.user.destroy |

> egg-sequelize时间问题：[链接](https://blog.csdn.net/bbsyi/article/details/108852653)